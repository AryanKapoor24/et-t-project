<!--
Cosmic Intelligence Interface
Starter code will be enhanced to meet all Hollywood-level requirements as specified.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cosmic Intelligence Interface</title>
  <!-- All CSS and JS will be embedded and modularized for easy extension -->
  <style>
    /* ...existing starter CSS... */
    #cosmic-controls {
          #cosmic-controls label, #cosmic-controls button {
            margin-bottom: 10px;
            font-size: 1.1em;
            cursor: pointer;
          }
          #cosmic-controls button {
            display: block;
            width: 100%;
            margin-top: 10px;
            background: #222a;
            border: 1px solid #444;
            color: #fff;
            border-radius: 6px;
            padding: 8px 0;
            font-size: 1em;
            transition: background 0.2s;
          }
          #cosmic-controls button:hover {
            background: #444a;
          }
      position: absolute;
      top: 24px;
      right: 24px;
      background: rgba(10,10,20,0.85);
      color: #fff;
      border-radius: 12px;
      padding: 18px 22px;
      z-index: 10;
      font-family: inherit;
      box-shadow: 0 2px 16px #000a;
    }
    #cosmic-controls label {
      display: block;
      margin-bottom: 10px;
      font-size: 1.1em;
      cursor: pointer;
    }
    #cosmic-controls input[type="checkbox"] {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <!-- Cinematic Effects -->
  <div id="cosmic-controls">
      <label><input type="checkbox" id="toggle-zoom">Endless Zoom</label>
      <button id="reset-zoom">Reset Zoom</button>
    <label><input type="checkbox" id="toggle-galaxies" checked>Show Galaxies</label>
    <label><input type="checkbox" id="toggle-nebulae" checked>Show Nebulae</label>
    <label><input type="checkbox" id="toggle-heavenly" checked>Show Heavenly Bodies</label>
    <label><input type="checkbox" id="toggle-animate" checked>Animate Phenomena</label>
    <button id="highlight-random">Highlight Random Phenomenon</button>
  </div>
  <div class="cinematic-overlay"></div>
  <div class="film-grain"></div>
  <!-- 3D Canvas -->
  <div id="canvas-container"></div>
  <!-- AI Interface Layer -->
  <div id="ai-interface">
    <!-- ...existing starter HTML... -->
  </div>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "gsap": "https://unpkg.com/gsap@3.12.2/index.js",
        "@xenova/transformers": "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0/dist/transformers.min.js"
      }
    }
  </script>
  <script type="module">
    // === STAGE 1: PHOTOREALISTIC SOLAR SYSTEM ===
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';
    import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';

    // 1. Scene, Camera, Renderer
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020205);
    scene.fog = new THREE.FogExp2(0x020205, 0.0005);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
    camera.position.set(0, 40, 120);

    const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.1;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // 2. Post-processing: Bloom, Film Grain, Vignette, Color Grading
    const composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85));
    composer.addPass(new FilmPass(0.35, 0.025, 648, false));
    // Vignette/Color Grading (simple custom shader)
    const vignetteShader = {
      uniforms: {
        tDiffuse: { value: null },
        offset: { value: 1.1 },
        darkness: { value: 1.2 }
      },
      vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0); }`,
      fragmentShader: `uniform float offset; uniform float darkness; uniform sampler2D tDiffuse; varying vec2 vUv; void main() { vec4 texel = texture2D(tDiffuse, vUv); float dist = distance(vUv, vec2(0.5,0.5)); texel.rgb *= smoothstep(0.8, offset * 0.799, dist * (darkness + offset)); gl_FragColor = texel; }`
    };
    composer.addPass(new ShaderPass(vignetteShader));

    // 3. Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 20;
    controls.maxDistance = 500;

    // 4. Starfield (15,000 twinkling stars)
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 15000;
    const starPositions = new Float32Array(starCount * 3);
    const starColors = new Float32Array(starCount * 3);
    for (let i = 0; i < starCount; i++) {
      const i3 = i * 3;
      const radius = 800 + Math.random() * 2000;
      const theta = Math.random() * Math.PI * 2;
      const phi = Math.acos(2 * Math.random() - 1);
      starPositions[i3] = radius * Math.sin(phi) * Math.cos(theta);
      starPositions[i3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
      starPositions[i3 + 2] = radius * Math.cos(phi);
      // Realistic star colors
      const temp = Math.random();
      const color = new THREE.Color();
      if (temp < 0.05) color.setHex(0x9bb0ff);
      else if (temp < 0.15) color.setHex(0xaabfff);
      else if (temp < 0.4) color.setHex(0xfff4e8);
      else if (temp < 0.7) color.setHex(0xffd2a1);
      else color.setHex(0xffcc6f);
      starColors[i3] = color.r;
      starColors[i3 + 1] = color.g;
      starColors[i3 + 2] = color.b;
    }
    starGeometry.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
    starGeometry.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
    const starMaterial = new THREE.PointsMaterial({ size: 1.5, vertexColors: true, transparent: true, opacity: 0.9, sizeAttenuation: true, blending: THREE.AdditiveBlending });
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);

    // 5. Galaxies and Space Phenomena
    // Helper to add a galaxy sprite
    function addGalaxySprite(textureUrl, position, scale = 400, opacity = 0.7, rotation = 0) {
      const loader = new THREE.TextureLoader();
      loader.load(textureUrl, (tex) => {
        const mat = new THREE.SpriteMaterial({ map: tex, color: 0xffffff, transparent: true, opacity });
        const sprite = new THREE.Sprite(mat);
        sprite.position.copy(position);
        sprite.scale.set(scale, scale, 1);
        sprite.material.rotation = rotation;
        scene.add(sprite);
      });
    }
    // --- ULTRA HYPER-REALISTIC PHENOMENA ---
    // Helper for glow effect with error logging and animation support
    const cosmicPhenomena = { galaxies: [], nebulae: [], heavenly: [] };
    function addGlowSprite(textureUrl, position, scale = 1200, color = 0xffffff, opacity = 1.0, rotation = 0, blend = THREE.AdditiveBlending, type = 'galaxies') {
      const loader = new THREE.TextureLoader();
      loader.load(
        textureUrl,
        (tex) => {
          const mat = new THREE.SpriteMaterial({ map: tex, color, transparent: true, opacity, blending: blend, depthWrite: false });
          const sprite = new THREE.Sprite(mat);
          sprite.position.copy(position);
          sprite.scale.set(scale, scale, 1);
          sprite.material.rotation = rotation;
          scene.add(sprite);
          cosmicPhenomena[type].push(sprite);
        },
        undefined,
        (err) => {
          console.error('Texture load error:', textureUrl, err);
        }
      );
    }

    // Ultra high-res spiral galaxies (layered for depth and glow, larger/brighter)
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/galaxies/m101_hubble.jpg', new THREE.Vector3(-1200, 800, -1800), 1400, 0xffffff, 1.2, Math.PI/4, THREE.AdditiveBlending, 'galaxies');
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/galaxies/m51_whirlpool.jpg', new THREE.Vector3(1500, -600, -2200), 1200, 0xffffff, 1.1, Math.PI/3, THREE.AdditiveBlending, 'galaxies');
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/galaxies/ngc1300_hubble.jpg', new THREE.Vector3(0, 1200, -2500), 1600, 0xffffff, 1.0, Math.PI/6, THREE.AdditiveBlending, 'galaxies');

    // Ultra high-res nebulae (layered, colored, with glow, larger/brighter)
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/nebulae/orion_hubble.jpg', new THREE.Vector3(-1500, 1200, -2300), 1800, 0x99ccff, 0.7, Math.PI/9, THREE.AdditiveBlending, 'nebulae');
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/nebulae/eagle_pillars.jpg', new THREE.Vector3(900, 900, -2100), 2000, 0xffeedd, 0.6, Math.PI/7, THREE.AdditiveBlending, 'nebulae');
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/nebulae/carina_hubble.jpg', new THREE.Vector3(1700, -1000, -2500), 2200, 0xffccbb, 0.5, Math.PI/10, THREE.AdditiveBlending, 'nebulae');
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/nebulae/helix_hubble.jpg', new THREE.Vector3(0, 1800, -2200), 1600, 0x99ffff, 0.6, Math.PI/11, THREE.AdditiveBlending, 'nebulae');

    // Supernova remnant (with strong glow)
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/supernovae/sn1987a_hubble.jpg', new THREE.Vector3(0, -1200, -2300), 1400, 0xffeedd, 1.0, Math.PI/2, THREE.AdditiveBlending, 'nebulae');

    // Globular cluster (soft glow)
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/clusters/m13_hercules.jpg', new THREE.Vector3(-2000, -1500, -2700), 1200, 0xffffff, 0.7, Math.PI/12, THREE.AdditiveBlending, 'heavenly');

    // Quasar (small, intense glow)
    addGlowSprite('https://cdn.jsdelivr.net/gh/astronexus/astroimages@main/quasars/3c273_hubble.jpg', new THREE.Vector3(2000, 0, -2800), 600, 0xffffff, 1.5, Math.PI/13, THREE.AdditiveBlending, 'heavenly');

    // Ultra-bright heavenly bodies (giant stars with colored glow)
    function addUltraHeavenlyBody(color, position, scale = 400, opacity = 1.0) {
      // Outer glow
      const glowMat = new THREE.SpriteMaterial({ color, transparent: true, opacity: opacity * 0.5, blending: THREE.AdditiveBlending, depthWrite: false });
      const glow = new THREE.Sprite(glowMat);
      glow.position.copy(position);
      glow.scale.set(scale * 2.8, scale * 2.8, 1);
      scene.add(glow);
      // Core
      const coreMat = new THREE.SpriteMaterial({ color, transparent: true, opacity, blending: THREE.AdditiveBlending, depthWrite: false });
      const core = new THREE.Sprite(coreMat);
      core.position.copy(position);
      core.scale.set(scale, scale, 1);
      scene.add(core);
      cosmicPhenomena.heavenly.push(glow, core);
    }
    addUltraHeavenlyBody(0xfff4e8, new THREE.Vector3(-1000, 2000, -2100), 400, 1.0); // Giant white star
    addUltraHeavenlyBody(0xffcc6f, new THREE.Vector3(1800, 1800, -2500), 320, 1.0); // Orange supergiant
    addUltraHeavenlyBody(0x9bb0ff, new THREE.Vector3(-1800, -1800, -2600), 360, 1.0); // Blue giant

    // 5. Sun (photorealistic, volumetric lighting, corona, city lights, etc.)
    // ...for brevity, sun and planet code will be modularized in next substage...

    // 6. Animation loop
    // Animation state
    let animatePhenomena = true;
    let endlessZoom = false;
    let zoomSpeed = 0.7; // units per frame
    let zoomMin = 40;
    let zoomMax = 4000;
    function animate() {
      requestAnimationFrame(animate);
      // Endless zoom: move camera forward, reset if too far
      if (endlessZoom) {
        const dir = new THREE.Vector3();
        camera.getWorldDirection(dir);
        camera.position.addScaledVector(dir, zoomSpeed);
        if (camera.position.length() > zoomMax) {
          camera.position.setLength(zoomMin);
        }
        controls.target.set(0,0,0); // always look at center
        controls.update();
      } else {
        controls.update();
      }
      // Animate rotation of galaxies/nebulae if enabled
      if (animatePhenomena) {
        cosmicPhenomena.galaxies.forEach(s => s.material.rotation += 0.0007);
        cosmicPhenomena.nebulae.forEach(s => s.material.rotation -= 0.0004);
      }
      composer.render();
    }
    animate();
    // --- ENDLESS ZOOM CONTROLS ---
    document.getElementById('toggle-zoom').addEventListener('change', e => {
      endlessZoom = e.target.checked;
      if (endlessZoom) {
        controls.enablePan = false;
        controls.enableZoom = false;
      } else {
        controls.enablePan = true;
        controls.enableZoom = true;
      }
    });
    document.getElementById('reset-zoom').addEventListener('click', () => {
      camera.position.set(0, 40, 120);
      controls.target.set(0,0,0);
      controls.update();
    });

    // --- INTERACTIVE CONTROLS ---
    function setPhenomenaVisible(type, visible) {
      cosmicPhenomena[type].forEach(s => s.visible = visible);
    }
    document.getElementById('toggle-galaxies').addEventListener('change', e => setPhenomenaVisible('galaxies', e.target.checked));
    document.getElementById('toggle-nebulae').addEventListener('change', e => setPhenomenaVisible('nebulae', e.target.checked));
    document.getElementById('toggle-heavenly').addEventListener('change', e => setPhenomenaVisible('heavenly', e.target.checked));
    document.getElementById('toggle-animate').addEventListener('change', e => animatePhenomena = e.target.checked);
    document.getElementById('highlight-random').addEventListener('click', () => {
      // Pick a random phenomenon and pulse its scale/opacity
      const all = [...cosmicPhenomena.galaxies, ...cosmicPhenomena.nebulae, ...cosmicPhenomena.heavenly];
      if (all.length === 0) return;
      const pick = all[Math.floor(Math.random() * all.length)];
      const origScale = pick.scale.x;
      const origOpacity = pick.material.opacity;
      let t = 0;
      function pulse() {
        t += 0.08;
        pick.scale.set(origScale * (1.2 + 0.2 * Math.sin(t * 2)), origScale * (1.2 + 0.2 * Math.sin(t * 2)), 1);
        pick.material.opacity = origOpacity * (1.0 + 0.5 * Math.abs(Math.sin(t)));
        if (t < Math.PI * 2) requestAnimationFrame(pulse);
        else {
          pick.scale.set(origScale, origScale, 1);
          pick.material.opacity = origOpacity;
        }
      }
      pulse();
    });
  </script>
</body>
</html>
